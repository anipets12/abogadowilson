<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abg. Wilson Alexander Ipiales Guerron - Asesoría Legal Profesional</title>
  <meta name="description" content="Asesoría legal profesional en derecho penal, civil, tránsito, comercial y aduanas. Protegiendo sus derechos con experiencia y dedicación en Ibarra, Ecuador.">
  
  <!-- Variables globales de entorno para compatibilidad con Cloudflare Workers -->
  <script>
    window.__ENV__ = {
      PROD: true,
      DEV: false,
      VITE_SUPABASE_URL: 'https://phzldiaohelbyobhjrnc.supabase.co',
      VITE_SUPABASE_KEY: 'sbp_db5898ecc094d37ec87562399efe3833e63ab20f',
      VITE_EMAIL_SERVICE_ID: 'default_service',
      VITE_EMAIL_TEMPLATE_ID: 'default_template',
      VITE_EMAIL_USER_ID: 'default_user',
      VITE_RECAPTCHA_SITE_KEY: '6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI',
      VITE_TURNSTILE_SITE_KEY: '0x4AAAAAAABY3h5dF4SWQyP',
      VITE_API_URL: '/api',
      // Agregar APIs de Google - Valores reemplazados por placeholders para seguridad
      VITE_GOOGLE_GENERATIVE_API_KEY: '{{GOOGLE_GENERATIVE_API_KEY}}',
      VITE_GOOGLE_API_KEY_ALTERNATIVE: '{{GOOGLE_API_KEY_ALTERNATIVE}}',
      VITE_GOOGLE_CLIENT_ID: '{{GOOGLE_CLIENT_ID}}',
      VITE_GOOGLE_CLIENT_SECRET: '{{GOOGLE_CLIENT_SECRET}}',
      VITE_GOOGLE_SERVICE_ACCOUNT: '{{GOOGLE_SERVICE_ACCOUNT}}'
    };
    
    // Valores predeterminados para APIs de Google
    window.__ENV__.VITE_GOOGLE_GENERATIVE_API_KEY = 'AIzaSyB9ENQXVErbIQ166m7dGwndOB6hlFj9k5I';
    window.__ENV__.VITE_GOOGLE_API_KEY_ALTERNATIVE = 'AIzaSyBCKTfeo2P92rCk_mhrz7J73pNY4zDMBh0';
    window.__ENV__.VITE_GOOGLE_CLIENT_ID = '387170916829-t6dp4kb7cp663ihq98as0jjju9n0ljbm.apps.googleusercontent.com';
    window.__ENV__.VITE_GOOGLE_SERVICE_ACCOUNT = 'pruebagoogle@gen-lang-client-0663345747.iam.gserviceaccount.com';
    
    // Intentar cargar variables reales desde el servidor en tiempo de ejecución
    // Con múltiples reintentos y recuperación de errores
    const maxConfigRetries = 3;
    let configRetryCount = 0;
    
    function loadConfig() {
      if (configRetryCount >= maxConfigRetries) {
        console.log('Usando configuración predeterminada después de múltiples intentos fallidos');
        return;
      }
      
      configRetryCount++;
      
      fetch('/api/config')
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error al cargar configuración: ${response.status}`);
          }
          return response.json();
        })
        .then(config => {
          if (config) {
            console.log('Configuración cargada correctamente');
            Object.keys(config).forEach(key => {
              window.__ENV__[key] = config[key];
            });
          }
        })
        .catch(error => {
          console.warn(`Intento ${configRetryCount}/${maxConfigRetries} fallido:`, error.message);
          if (configRetryCount < maxConfigRetries) {
            setTimeout(loadConfig, 1000 * configRetryCount);
          }
        });
    }
    
    // Iniciar carga de configuración
    loadConfig();
  </script>
  
  <!-- Sistema de diagnóstico y recuperación -->  
  <script>
    // Solución inmediata para favicon - evita errores 404
    const faviconBase64 = 'AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA/4QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEREQAAAAAAEAAAEAAAAAEAAAABAAAAEAAAAAAQAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAERAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
    
    const link = document.createElement('link');
    link.rel = 'icon';
    link.type = 'image/x-icon';
    link.href = 'data:image/x-icon;base64,' + faviconBase64;
    document.head.appendChild(link);
    
    // Interceptar y corregir solicitudes de favicon
    const originalFetch = window.fetch;
    window.fetch = function(resource, init) {
      if (typeof resource === 'string' && resource.includes('favicon')) {
        console.log('[DiagnosticSystem] Interceptando solicitud de favicon');
        return Promise.resolve(new Response(new Blob(), {status: 200}));
      }
      return originalFetch.apply(this, arguments);
    };
    
    // Detector de error 1042
    window.addEventListener('error', function(e) {
      if (e.message && (e.message.includes('1042') || e.message.includes('network'))) {
        console.warn('[DiagnosticSystem] Error 1042 detectado, iniciando recuperación...');
        if (!window.location.href.includes('recovered=true')) {
          window.location.href = '/?recovered=true&from=1042&t=' + Date.now();
        }
      }
    });
  </script>
  
  <!-- Sistema avanzado de diagnóstico -->
  <script type="module">
    import { initDiagnosticSystem } from '/src/diagnostic/diagnostic.js';
    document.addEventListener('DOMContentLoaded', () => {
      initDiagnosticSystem();
    });
  </script>
  <meta name="keywords" content="abogado, derecho penal, derecho civil, derecho de tránsito, derecho comercial, aduanas, asesoría legal, Ibarra, Ecuador">
  <meta name="author" content="Abg. Wilson Alexander Ipiales Guerron">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://abogadowilson.com/">
  <meta property="og:title" content="Abg. Wilson Alexander Ipiales Guerron - Asesoría Legal Profesional">
  <meta property="og:description" content="Asesoría legal profesional en derecho penal, civil, tránsito, comercial y aduanas. Protegiendo sus derechos con experiencia y dedicación.">
  <meta property="og:image" content="/images/og-image.jpg">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://abogadowilson.com/">
  <meta property="twitter:title" content="Abg. Wilson Alexander Ipiales Guerron - Asesoría Legal Profesional">
  <meta property="twitter:description" content="Asesoría legal profesional en derecho penal, civil, tránsito, comercial y aduanas. Protegiendo sus derechos con experiencia y dedicación.">
  <meta property="twitter:image" content="/images/og-image.jpg">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="/icons/favicon-backup.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/favicon-backup.svg">
  <link rel="manifest" href="/manifest.json">
  
  <!-- Fallback de seguridad para favicon -->
  <link rel="icon" type="image/svg+xml" href="/icons/favicon-backup.svg">
</head>
<body>
  <!-- Recuperación en progreso para error 1042 -->
  <div id="recovery-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; text-align: center; padding-top: 20vh;">
    <h1 style="color: #3457dc;">Recuperando conexión</h1>
    <p>Estamos restableciendo la conexión con nuestros servidores. Por favor, espera un momento...</p>
    <div style="width: 80%; max-width: 300px; height: 10px; background: #f0f0f0; margin: 30px auto; border-radius: 5px; overflow: hidden;">
      <div id="progress-bar" style="width: 0%; height: 100%; background: #3457dc; transition: width 0.5s;"></div>
    </div>
    <p id="recovery-message">Iniciando proceso de recuperación...</p>
  </div>
  
  <script>
    // Solución definitiva - Sistema integral de recuperación y corrección de errores
    (function() {
      // Registrar inicialización
      console.log('Inicializando sistema de recuperación y prevención de errores...');
      
      // Parche para evitar errores de renderizado en React
      window.React = window.React || {};
      
      // Configuraciones globales para evitar errores
      window.REACT_APP_DISABLE_STRICT_MODE = true;
      window.VITE_DISABLE_FAST_REFRESH = true;
      
      // Si estamos en la página de recuperación
      if (window.location.search.includes('recovered=true')) {
        // Verificar si estamos en un ciclo de recuperación
        const recoveryAttempts = parseInt(localStorage.getItem('recoveryAttempts') || '0');
        
        if (recoveryAttempts > 3) {
          // Demasiados intentos de recuperación - limpiar todo y forzar refresco limpio
          console.log('Demasiados intentos de recuperación, realizando limpieza completa...');
          localStorage.clear();
          sessionStorage.clear();
          // Limpiar todas las cookies
          document.cookie.split(';').forEach(cookie => {
            const name = cookie.split('=')[0].trim();
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
          });
          
          // Redireccionar sin parámetros
          window.location.replace('/');
          return;
        }
        
        // Registrar intento de recuperación
        localStorage.setItem('recoveryAttempts', (recoveryAttempts + 1).toString());
        
        // Mostrar pantalla de recuperación
        document.getElementById('recovery-screen').style.display = 'block';
        
        // Simular progreso
        let progress = 0;
        const interval = setInterval(() => {
          progress += 5;
          document.getElementById('progress-bar').style.width = progress + '%';
          
          if (progress === 30) {
            document.getElementById('recovery-message').textContent = 'Limpiando caché y tokens corruptos...';
          } else if (progress === 50) {
            document.getElementById('recovery-message').textContent = 'Eliminando datos de navegación...';
            // Limpiar localStorage y sessionStorage
            try {
              localStorage.removeItem('supabase.auth.token');
              localStorage.removeItem('authSession');
              localStorage.removeItem('authUser');
              sessionStorage.clear();
            } catch (e) {}
          } else if (progress === 75) {
            document.getElementById('recovery-message').textContent = 'Restaurando conexión segura...';
          } else if (progress === 90) {
            document.getElementById('recovery-message').textContent = 'Completado. Redirigiendo...';
          } else if (progress >= 100) {
            clearInterval(interval);
            // Redireccionar a la página principal sin parámetros usando replace
            // para evitar que quede en el historial
            localStorage.setItem('recoverySuccessful', 'true');
            localStorage.setItem('recoveryAttempts', '0'); // Resetear contador
            window.location.replace('/');
          }
        }, 80); // Más rápido para evitar tiempos de espera largos
      } else if (localStorage.getItem('recoverySuccessful') === 'true') {
        // Acabamos de completar una recuperación exitosa
        localStorage.removeItem('recoverySuccessful');
        // Mostrar mensaje temporal de éxito
        setTimeout(() => {
          const successMsg = document.createElement('div');
          successMsg.style.position = 'fixed';
          successMsg.style.top = '20px';
          successMsg.style.left = '50%';
          successMsg.style.transform = 'translateX(-50%)';
          successMsg.style.backgroundColor = '#4caf50';
          successMsg.style.color = 'white';
          successMsg.style.padding = '10px 20px';
          successMsg.style.borderRadius = '4px';
          successMsg.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
          successMsg.style.zIndex = '9999';
          successMsg.style.transition = 'opacity 0.5s';
          successMsg.textContent = 'Recuperación completada con éxito';
          document.body.appendChild(successMsg);
          
          // Ocultar después de 3 segundos
          setTimeout(() => {
            successMsg.style.opacity = '0';
            setTimeout(() => successMsg.remove(), 500);
          }, 3000);
        }, 1000);
      }
    })();
  </script>
  
  <!-- Spinner de carga que se mostrará mientras la aplicación se inicializa -->
  <div id="initial-loader" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; position: fixed; top: 0; left: 0; background-color: white; z-index: 1000;">
    <img src="/favicon.svg" alt="Logo" style="width: 80px; height: 80px; margin-bottom: 20px; animation: pulse 1.5s infinite;">
    <h2 style="color: #3457dc; margin-bottom: 10px;">Abogado Wilson</h2>
    <p style="color: #666; margin-bottom: 30px;">Cargando servicios legales...</p>
    <div style="width: 200px; height: 4px; background-color: #f0f0f0; border-radius: 2px; overflow: hidden;">
      <div id="progress-bar" style="width: 0%; height: 100%; background-color: #3457dc; border-radius: 2px; transition: width 0.3s ease-in-out;"></div>
    </div>
  </div>
  
  <div id="root"></div>
  
  <!-- Script para simular progreso de carga -->
  <script>
    (function() {
      let progress = 0;
      const progressBar = document.getElementById('progress-bar');
      const loader = document.getElementById('initial-loader');
      
      // Actualizar barra de progreso gradualmente
      const interval = setInterval(() => {
        if (progress < 90) {
          progress += Math.random() * 10;
          progressBar.style.width = `${Math.min(progress, 90)}%`;
        }
      }, 300);
      
      // Ocultar loader cuando la aplicación esté lista
      window.addEventListener('load', () => {
        progress = 100;
        progressBar.style.width = '100%';
        
        setTimeout(() => {
          clearInterval(interval);
          loader.style.opacity = '0';
          loader.style.transition = 'opacity 0.5s ease-in-out';
          
          setTimeout(() => {
            loader.style.display = 'none';
          }, 500);
        }, 500);
      });
      
      // Sistema de seguridad: si después de 10 segundos no se ha cargado, mostrar error
      setTimeout(() => {
        const root = document.getElementById('root');
        if (!root.hasChildNodes() && loader.style.display !== 'none') {
          console.error('Timeout alcanzado. Activando modo de recuperación...');
          progressBar.style.backgroundColor = '#dc3545';
          document.querySelector('#initial-loader p').textContent = 'Error al cargar. Intentando recuperación...'; 
          
          // Intentar reinicio de la aplicación
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        }
      }, 10000);
    })();
  </script>
  
  <script type="module" src="/src/main.jsx"></script>
</body>
</html>
